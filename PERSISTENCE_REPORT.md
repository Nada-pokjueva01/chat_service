# 채팅 서비스 안정성 이슈 및 해결 방법 리포트

이번 채팅 서비스 고도화 과정에서 발생한 주요 장애 현상과 그 원인, 그리고 최종 해결 방안을 정리한 문서입니다.

## 1. 주요 발생 현상 (Issues)

1.  **채팅방 파편화 (Conversation Splitting)**:
    - 사용자가 같은 채팅방에서 여러 번 질문을 던졌음에도 불구하고, 각각의 질문과 답변이 서로 다른 새로운 채팅방으로 분리되어 저장되는 현상.
2.  **대화 내용 소실 및 중복 (History Loss & Duplication)**:
    - 채팅방 전환 시 이전 대화 내용이 나타나지 않거나, 특정 상황에서 동일한 메시지가 이중으로 표시되는 현상.
3.  **동기화 오류 (State Sync Issue)**:
    - 사이드바의 미리보기와 실제 채팅창의 내용이 일치하지 않거나, 메시지 개수 카운트가 비정상적으로 작동하는 현상.

---

## 2. 근본 원인 분석 (Root Causes)

### ❌ 레거시/유효하지 않은 코드 사용 (AI SDK v6 미준수)
가장 핵심적인 원인은 **Vercel AI SDK v6** 환경에서 이전 버전(v3 등)의 레거시 API 구조를 사용했기 때문입니다.

*   **잘못된 API 호출**: v6에서는 `append` 함수가 아닌 `sendMessage`를 사용해야 합니다. 
*   **Signature 불일치**: `append`를 억지로 사용하거나 `sendMessage`의 인자 구조를 잘못 전달할 경우, **`conversationId`가 요청 바디(Request Body)의 루트에서 누락**됩니다.
*   **결과**: 서버는 `conversationId`를 받지 못해 새로운 방으로 오인하고 매번 `conv_[timestamp]` 형태의 새 ID를 생성하여 저장하게 됩니다. 이것이 채팅방이 파편화되는 결정적인 이유였습니다.

### ❌ 불안정한 상태 업데이트 로직
*   **데이터 덮어쓰기**: 대화가 끝난 직후 `loadMessages`(DB 조회)가 호출될 때, 서버에 아직 저장 중인 데이터가 반영되지 않은 '과거 상태'를 가져와 현재 메모리에 있는 '최신 상태'를 덮어씌우면서 대화가 사라진 것처럼 보이게 됩니다.
*   **이중 메시지 현상**: 낙관적 업데이트(Optimistic UI)와 SDK의 자동 메시지 추가 로직이 충돌하거나, 레거시 코드의 재시도 로직이 겹치면서 동일 메시지가 두 번 저장되는 문제가 발생했습니다.

---

## 3. 최종 해결 방안 (Final Solutions)

### ✅ Vercel AI SDK v6 표준 준수
클라이언트(`AIAssistantUI.jsx`)에서 v6 전용 API인 `sendMessage`를 정확한 규격으로 사용하도록 수정했습니다.

```javascript
// ✅ 올바른 v6 방식: 첫 번째 인자는 메시지 객체, 두 번째 인자는 옵션(body 포함)
await sendMessage({
  text: currentInput,
}, {
  body: { conversationId: selectedId }
});
```

### ✅ 서버 사이드 안정 장치 (`route.ts`)
*   클라이언트로부터 전달받은 `conversationId`를 최우선으로 사용합니다.
*   DB에 해당 대화방 정보가 없는 경우에만 자동 생성하도록 로직을 강화하여 데이터 유실 없는 안정적인 저장소를 보장합니다.

### ✅ 지능적 데이터 로딩 (`loadMessages`)
*   `loadMessages` 호출 시 현재 메모리에 있는 라이브 대화가 더 최신일 경우, 비어있는 DB 데이터로 덮어씌우지 않도록 안전 로직을 추가했습니다.
*   `onFinish` 콜백을 통해 대화 종료 시점에만 사이드바 메타데이터(미리보기, 시간)를 동기화하여 불필요한 전체 리로드를 방지했습니다.

---

## 💡 레슨 런 (Lessons Learned)

> [!WARNING]
> **AI SDK v6를 사용하지 않고 레거시 코드로 구현할 경우:**
> - `conversationId` 전송 누락으로 인해 **질문마다 채팅방이 무한 생성**됩니다.
> - 상태 관리 충돌로 인해 **이전 대화가 사라지거나 메시지가 중복**되는 치명적인 UX 저하가 발생합니다.
> - 최신 라이브러리 버전에 맞는 **정확한 API Signature(sendMessage 등)**를 확인하고 적용하는 것이 안정적인 서비스 운영의 핵심입니다.
